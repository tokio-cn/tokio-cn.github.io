<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <link rel="apple-touch-icon" sizes="120x120" href="https://tokio-cn.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://tokio-cn.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://tokio-cn.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://tokio-cn.github.io/manifest.json">
    <link rel="mask-icon" href="https://tokio-cn.github.io/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#ffffff">

    
    <link rel="stylesheet" href="https://tokio-cn.github.io/css/bootstrap-reboot.css">
    <link rel="stylesheet" href="https://tokio-cn.github.io/css/bootstrap.css">
    <link rel="stylesheet" href="https://tokio-cn.github.io/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://tokio-cn.github.io/css/tokio.css">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css"/>

    
    <link rel="alternate" type="application/rss+xml" href="https://tokio-cn.github.io/blog/index.xml" />

    <title>
      
        Tokio alpha release with async &amp; await · Tokio 中文站
      
    </title>
  </head>
  <body>
    <header class="navbar navbar-expand navbar-dark flex-column flex-md-row tk-navbar">
      <a class="navbar-brand" href="https://tokio-cn.github.io/">
        <img src="https://tokio-cn.github.io/img/Tokio_Mark_White.png" class="align-middle" alt="">
      </a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link " href="https://tokio-cn.github.io/">首页</a>
          </li>
          <li class="nav-item">
            
            
            
            <a class="nav-link " href="https://tokio-cn.github.io/docs/getting-started/hello-world/">文档</a>
          </li>
          <li class="nav-item">
            
            <a class="nav-link " href="https://tokio-cn.github.io/community/">社区</a>
          </li>
          <li class="nav-item">
            
            
            <a class="nav-link  active " href="https://tokio-cn.github.io/blog/2019-12-compat/">博客</a>
          </li>
        </ul>
      </div>

      <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex">
        <li class="nav-item dropdown">
          <a class="nav-item nav-link dropdown-toggle mr-md-2" href="#" id="tk-langs" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            中文
          </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="tk-langs">
            <a class="dropdown-item active" href="#">中文</a>
            <a class="dropdown-item" href="https://tokio-zh.github.io/" rel="nofollow">官方中文</a>
            <a class="dropdown-item" href="https://tokio.rs" rel="nofollow">English</a>
          </div>
        </li>
        <li class="nav-item">
          <a class="nav-link p-2" href="https://github.com/tokio-rs/tokio" target="_blank" rel="noopener" aria-label="GitHub">
            <svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 499.36" focusable="false"><title>GitHub</title><path d="M256 0C114.64 0 0 114.61 0 256c0 113.09 73.34 209 175.08 242.9 12.8 2.35 17.47-5.56 17.47-12.34 0-6.08-.22-22.18-.35-43.54-71.2 15.49-86.2-34.34-86.2-34.34-11.64-29.57-28.42-37.45-28.42-37.45-23.27-15.84 1.73-15.55 1.73-15.55 25.69 1.81 39.21 26.38 39.21 26.38 22.84 39.12 59.92 27.82 74.5 21.27 2.33-16.54 8.94-27.82 16.25-34.22-56.84-6.43-116.6-28.43-116.6-126.49 0-27.95 10-50.8 26.35-68.69-2.63-6.48-11.42-32.5 2.51-67.75 0 0 21.49-6.88 70.4 26.24a242.65 242.65 0 0 1 128.18 0c48.87-33.13 70.33-26.24 70.33-26.24 14 35.25 5.18 61.27 2.55 67.75 16.41 17.9 26.31 40.75 26.31 68.69 0 98.35-59.85 120-116.88 126.32 9.19 7.9 17.38 23.53 17.38 47.41 0 34.22-.31 61.83-.31 70.23 0 6.85 4.61 14.81 17.6 12.31C438.72 464.97 512 369.08 512 256.02 512 114.62 397.37 0 256 0z" fill="currentColor" fill-rule="evenodd"/></svg>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link p-2" href="https://twitter.com/tokio_rs" target="_blank" rel="noopener" aria-label="Twitter">
            <svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 416.32" focusable="false"><title>Twitter</title><path d="M160.83 416.32c193.2 0 298.92-160.22 298.92-298.92 0-4.51 0-9-.2-13.52A214 214 0 0 0 512 49.38a212.93 212.93 0 0 1-60.44 16.6 105.7 105.7 0 0 0 46.3-58.19 209 209 0 0 1-66.79 25.37 105.09 105.09 0 0 0-181.73 71.91 116.12 116.12 0 0 0 2.66 24c-87.28-4.3-164.73-46.3-216.56-109.82A105.48 105.48 0 0 0 68 159.6a106.27 106.27 0 0 1-47.53-13.11v1.43a105.28 105.28 0 0 0 84.21 103.06 105.67 105.67 0 0 1-47.33 1.84 105.06 105.06 0 0 0 98.14 72.94A210.72 210.72 0 0 1 25 370.84a202.17 202.17 0 0 1-25-1.43 298.85 298.85 0 0 0 160.83 46.92" fill="currentColor"/></svg>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link p-2" href="https://discord.gg/tokio" target="_blank" rel="noopener" aria-label="Discord">
            <svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 245 240" focusable="false"><title>Discord</title><path d="M104.4 103.9c-5.7 0-10.2 5-10.2 11.1s4.6 11.1 10.2 11.1c5.7 0 10.2-5 10.2-11.1.1-6.1-4.5-11.1-10.2-11.1zM140.9 103.9c-5.7 0-10.2 5-10.2 11.1s4.6 11.1 10.2 11.1c5.7 0 10.2-5 10.2-11.1s-4.5-11.1-10.2-11.1z" fill="currentColor"/><path d="M189.5 20h-134C44.2 20 35 29.2 35 40.6v135.2c0 11.4 9.2 20.6 20.5 20.6h113.4l-5.3-18.5 12.8 11.9 12.1 11.2 21.5 19V40.6c0-11.4-9.2-20.6-20.5-20.6zm-38.6 130.6s-3.6-4.3-6.6-8.1c13.1-3.7 18.1-11.9 18.1-11.9-4.1 2.7-8 4.6-11.5 5.9-5 2.1-9.8 3.5-14.5 4.3-9.6 1.8-18.4 1.3-25.9-.1-5.7-1.1-10.6-2.7-14.7-4.3-2.3-.9-4.8-2-7.3-3.4-.3-.2-.6-.3-.9-.5-.2-.1-.3-.2-.4-.3-1.8-1-2.8-1.7-2.8-1.7s4.8 8 17.5 11.8c-3 3.8-6.7 8.3-6.7 8.3-22.1-.7-30.5-15.2-30.5-15.2 0-32.2 14.4-58.3 14.4-58.3 14.4-10.8 28.1-10.5 28.1-10.5l1 1.2c-18 5.2-26.3 13.1-26.3 13.1s2.2-1.2 5.9-2.9c10.7-4.7 19.2-6 22.7-6.3.6-.1 1.1-.2 1.7-.2 6.1-.8 13-1 20.2-.2 9.5 1.1 19.7 3.9 30.1 9.6 0 0-7.9-7.5-24.9-12.7l1.4-1.6s13.7-.3 28.1 10.5c0 0 14.4 26.1 14.4 58.3 0 0-8.5 14.5-30.6 15.2z" fill="currentColor"/></svg>
          </a>
        </li>
      </ul>
    </header>



<div class="container-fluid tk-blog">
  <div class="row flex-xl-nowrap">
    <div class="col-12 col-md-3 col-xl-2 tk-sidebar">
      
      <div class="tk-docs-toggle d-md-none p-0 d-flex ml-3 collapsed align-item-center">
        <h1 class="tk-title">Tokio alpha release with async &amp; await</h1>
        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#tk-docs-nav" aria-controls="tk-docs-nav" aria-expanded="false" aria-label="Toggle docs navigation">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="30" height="30" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10" d="M4 7h22M4 15h22M4 23h22"></path></svg>
        </button>
      </div>
      <nav class="tk-links collapse" id="tk-docs-nav">
          <div class="tk-toc-item active">
            <p class="tk-toc-link">
              博文列表
            </p>
            <ul class="nav tk-sidenav">
              
              
                  <li><a href="https://tokio-cn.github.io/blog/2019-12-compat/" class="">Announcing Tokio-Compat</a></li>
              
                  <li><a href="https://tokio-cn.github.io/blog/2019-12-mio-v0.7-alpha.1/" class="">Announcing Mio 0.7-alpha.1</a></li>
              
                  <li><a href="https://tokio-cn.github.io/blog/2019-11-tokio-0-2/" class="">Announcing Tokio 0.2 and a Roadmap to 1.0</a></li>
              
                  <li><a href="https://tokio-cn.github.io/blog/2019-10-scheduler/" class="">Making the Tokio scheduler 10x faster</a></li>
              
                  <li><a href="https://tokio-cn.github.io/blog/2019-08-tracing/" class="">Diagnostics with Tracing</a></li>
              
                  <li><a href="https://tokio-cn.github.io/blog/2019-08-alphas/" class="active">Tokio alpha release with async &amp; await</a></li>
              
                  <li><a href="https://tokio-cn.github.io/blog/2018-12-recap-2018/" class="">A great 2018, an even better 2019</a></li>
              
                  <li><a href="https://tokio-cn.github.io/blog/2018-10-doc-blitz/" class="">Announcing the Tokio Doc Push (we need you!)</a></li>
              
                  <li><a href="https://tokio-cn.github.io/blog/2018-08-async-await/" class="">Experimental async / await support for Tokio</a></li>
              
                  <li><a href="https://tokio-cn.github.io/blog/2018-08-incremental-improvements/" class="">Tokio 0.1.8 with many incremental improvements</a></li>
              
                  <li><a href="https://tokio-cn.github.io/blog/2018-05-tokio-fs/" class="">New Tokio release, now with filesystem support</a></li>
              
                  <li><a href="https://tokio-cn.github.io/blog/2018-03-timers/" class="">New Timer implementation</a></li>
              
                  <li><a href="https://tokio-cn.github.io/blog/2018-03-tokio-runtime/" class="">Announcing the Tokio runtime</a></li>
              
                  <li><a href="https://tokio-cn.github.io/blog/2018-02-tokio-reform-shipped/" class="">Tokio Reform is Shipped and the Road to 0.2</a></li>
              
                  <li><a href="https://tokio-cn.github.io/blog/2017-09-tokio-reform/" class="">An RFC for a Tokio revamp</a></li>
              
                  <li><a href="https://tokio-cn.github.io/blog/2017-03-tokio-io/" class="">Announcing the tokio-io Crate</a></li>
              
                  <li><a href="https://tokio-cn.github.io/blog/2017-01-tokio-0-1/" class="">Announcing Tokio 0.1</a></li>
              
            </ul>
          </div>
      </nav>
    </div>
    <div class="d-none d-xl-block col-xl-2 tk-toc">
      <div class="section-nav">
        <nav id="TableOfContents">
<ul>
<li><a href="#the-road-so-far">The road so far</a></li>
<li><a href="#what-we-have-now">What we have now</a></li>
<li><a href="#towards-a-final-release">Towards a final release</a></li>
</ul>
</nav>
      </div>

    </div>
    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 tk-content tk-docs">
      <h1 class="tk-title">Tokio alpha release with async &amp; await</h1>
      <p class="tk-date">August 08, 2019</p>
      
      

<p>We&rsquo;re pleased to announce <a href="https://crates.io/crates/tokio/0.2.0-alpha.1">the release</a> of the first Tokio alpha with async &amp; await
support. This includes updating all of the Tokio crates to use <code>std::future</code>
instead of <code>futures</code> 0.1. It also includes adding <code>async fn</code> versions of the
APIs.</p>

<p>Get it by adding:</p>

<pre><code class="language-toml">tokio = &quot;=0.2.0-alpha.1&quot;
</code></pre>

<p>to your <code>Cargo.toml</code> file. This is how an echo server is now written:</p>

<pre><code class="language-rust,ignore">#![feature(async_await)]

use tokio::net::TcpListener;
use tokio::prelude::*;

#[tokio::main]
async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
    let addr = &quot;127.0.0.1:8080&quot;.parse()?;
    let mut listener = TcpListener::bind(&amp;addr)?;

    loop {
        let (mut socket, _) = listener.accept().await?;

        tokio::spawn(async move {
            let mut buf = [0; 1024];

            // In a loop, read data from the socket and write the data back.
            loop {
                let n = match socket.read(&amp;mut buf).await {
                    // socket closed
                    Ok(n) if n == 0 =&gt; return,
                    Ok(n) =&gt; n,
                    Err(e) =&gt; {
                        println!(&quot;failed to read from socket; err = {:?}&quot;, e);
                        return;
                    }
                };

                // Write the data back
                if let Err(e) = socket.write_all(&amp;buf[0..n]).await {
                    println!(&quot;failed to write to socket; err = {:?}&quot;, e);
                    return;
                }
            }
        });
    }
}
</code></pre>

<p>More examples are in the <a href="https://github.com/tokio-rs/tokio/tree/master/tokio/examples">git repository</a>.</p>

<h1 id="the-road-so-far">The road so far</h1>

<p>Tokio was first announced almost exactly <a href="https://medium.com/@carllerche/announcing-tokio-df6bb4ddb34">three years
ago</a>. When Tokio was first released, it contained a minimal,
single-threaded, scheduler and APIs for TCP. Since then, it has grown to include
a multi-threaded work-stealing scheduler, APIs for timers, TCP, UDP, UDS, file
system access, signal handling, managing child processes, high performance async
aware channels, and more. All this thanks to a <a href="https://github.com/orgs/tokio-rs/people">dedicated team of
maintainers</a> and an <a href="https://github.com/tokio-rs/tokio/graphs/contributors">active community of contributors</a>. Tokio
would not be where it is without you! Thank you so much.</p>

<p>Tokio&rsquo;s goal has always been to provide an ergonomic library for writing
asynchronous applications for Rust without compromising on performance. The past
three years have been spent building out the Rust I/O ecosystem and discovering
idioms and patterns for writing asynchronous Rust. Over the past three years,
the Rust community built a vibrant ecosystem around Tokio.</p>

<p>Some libraries include:</p>

<ul>
<li>an <a href="https://github.com/hyperium/">HTTP client and server</a> (with <a href="https://github.com/hyperium/h2">HTTP/2.0 support</a>).</li>
<li>web frameworks (<a href="https://github.com/seanmonstar/warp/">warp</a>, <a href="https://github.com/actix/actix-web">actix</a>).</li>
<li>a <a href="https://github.com/djc/quinn">QUIC</a> implementation.</li>
<li><a href="https://github.com/tower-rs/tower">composable components</a> for building robust servers and clients.</li>
<li>a <a href="https://github.com/tower-rs/tower-grpc/">gRPC client and server</a></li>
</ul>

<p>(and of course, there are many more).</p>

<p>The number of users has been growing too! Users include:</p>

<ul>
<li><a href="https://linkerd.io/">Linkerd</a></li>
<li><a href="https://github.com/Azure/iotedge">Microsoft</a></li>
<li><a href="https://github.com/firecracker-microvm/firecracker">Amazon</a></li>
<li><a href="https://github.com/facebookexperimental/mononoke">Facebook</a></li>
<li><a href="https://vector.dev/">Vector</a></li>
<li><a href="https://github.com/denoland/deno">Deno</a></li>
<li><a href="https://github.com/libra/libra">Libra</a></li>
<li><a href="https://pingcap.com">PingCAP</a></li>
<li><a href="https://www.parity.io/">Parity</a></li>
</ul>

<p>Over the past three years, the Rust team has not been idle either. They have
been working tirelessly on a huge feature that will greatly improve the
experience of writing asynchronous code with Rust: <a href="https://github.com/rust-lang/rfcs/blob/master/text/2394-async_await.md">async &amp; await
syntax</a>. This new syntax is about to land on Rust stable.</p>

<p>All of Tokio&rsquo;s iteration to date was done while maintaining API stability. Tokio
has not had a breaking release since the very first 0.1.0 release on September
9, 2016. Understandably, a long list of changes to make has been building up.
The introduction of async &amp; await syntax is the right moment to make these
breaking changes.</p>

<h1 id="what-we-have-now">What we have now</h1>

<p>Today&rsquo;s release of Tokio <code>0.2.0-alpha.1</code> with async &amp; await updates all of Tokio&rsquo;s
components to use <a href="https://doc.rust-lang.org/std/"><code>std::future</code></a>, and all usage of <code>futures</code> 0.1
has been removed.</p>

<p>Changes include:</p>

<p><strong>Using async fns for asynchronous operations.</strong></p>

<p>When possible, <code>async fn</code> has been used to provide asynchronous operations. For
example, acceping sockets from a <code>TcpListener</code> is done with the async <code>accept</code>
function:</p>

<pre><code class="language-rust,ignore">let (mut socket, _) = listener.accept().await?;
</code></pre>

<p>I/O operations are provided as <code>async</code> functions:</p>

<pre><code class="language-rust,ignore">let n = socket.read(&amp;mut buf).await?;

let n = socket.write(&amp;buf).await?;
</code></pre>

<p>The same applies to most of the Tokio 0.2 APIs.</p>

<p><strong>Starting the Tokio runtime</strong></p>

<p>Setting the entry point of a Tokio application can now be done with a proc macro:</p>

<pre><code class="language-rust,ignore">#[tokio::main]
async fn main() {
    println!(&quot;Hello from Tokio!&quot;);
}
</code></pre>

<p>Creating a runtime by hand is still supported. The proc macro just provides some
sugar. The equivalent application would be:</p>

<pre><code class="language-rust,ignore">fn main() {
    let mut rt = Runtime::new().unwrap();
    rt.block_on(async {
        println!(&quot;Hello from Tokio!&quot;);
    });
}
</code></pre>

<p>There is also a proc macro for tests that will set up a current thread runtime to run your tests:</p>

<pre><code class="language-rust,ignore">#[tokio::test]
async fn my_test() {
    let addr = &quot;127.0.0.1:8080&quot;.parse().unwrap();
    let mut listener = TcpListener::bind(&amp;addr).unwrap();
    let addr = listener.local_addr().unwrap();

    // Connect to the listener
    TcpStream::connect(&amp;addr).await.unwrap();
}
</code></pre>

<p><strong>Nightly only</strong></p>

<p>Because async &amp; await are not available on the stable Rust channel yet, this
alpha release requires using nightly Rust. Tokio includes a
<a href="https://github.com/tokio-rs/tokio/blob/master/rust-toolchain">rust-toolchain</a> file that tracks the nightly Tokio tests again.</p>

<h1 id="towards-a-final-release">Towards a final release</h1>

<p>This alpha release represents the first step towards the next iteration of
Tokio. Users are now able to experiment using Tokio and async &amp; await syntax,
but nothing is set in stone.</p>

<p>The availability of async &amp; await syntax is the perfect time to issue a major
revision of the full stack. All of Tokio&rsquo;s components require more changes,
including ecosystem crates such as <a href="https://github.com/tokio-rs/mio"><code>mio</code></a>, <a href="https://github.com/tokio-rs/bytes"><code>bytes</code></a>, and
<a href="https://github.com/tokio-rs/tracing"><code>tracing</code></a>. Focus will be on tight integration and performance, i.e.
providing ergonomic high level APIs without sacrificing speed. Lessons learned
over the past three years will be applied. Follow up blog posts will cover these
changes in more detail as they happen.</p>

<p>As progress is made, alpha crates will be released. These releases will include
breaking changes. Progress can be tracked on the <a href="https://github.com/tokio-rs/tokio/issues?q=is%3Aopen+is%3Aissue+milestone%3Av0.2">issue tracker</a>.</p>

<p>Given the scope of the changes, it will take a few months before a final release
is ready. Estimating software release dates is hard, but let&rsquo;s aim for before the
end of the year.</p>

<p>There is a ton of work to done on code, testing, and documentation. As always,
your help is <strong>greatly</strong> appreciated! Check out the <a href="https://github.com/tokio-rs/tokio/issues?q=is%3Aopen+is%3Aissue+milestone%3Av0.2">issue tracker</a> or
ping us on <a href="https://gitter.im/tokio-rs/tokio">Gitter</a>. We&rsquo;re always happy to mentor!</p>

      

      
        <div class="tk-next">
          <b>下一篇</b>：<a href ="/blog/2018-12-recap-2018/">A great 2018, an even better 2019</a>
        </div>
      
    </main>
  </div>
</div>

    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js" integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8" crossorigin="anonymous"></script>
    <script src="https://tokio-cn.github.io/js/bootstrap.min.js"></script>
    <script src="https://tokio-cn.github.io/js/highlight.js"></script>
    <script>
      $(function () {
        $("pre code").each(function(i, block) {
          
          if (block.className.indexOf('language-rust') >= 0) {
            var new_content = '';
            var lines = block.textContent.split('\n');
            for (var i = 0; i < lines.length; i++) {
              if (lines[i].indexOf('# ') == 0 || lines[i] == '#') {
                continue
              }
              new_content += lines[i].trimRight() + '\n';
            }
            block.textContent = new_content.replace(/\n\n\n/g, "\n\n").trimRight();
          }
          hljs.highlightBlock(block);
        });
      });
    </script>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script type="text/javascript"> docsearch({
    apiKey: 'd7b5b785798fe748621bcaa8301a2201',
    indexName: 'tokio',
    inputSelector: '#search-input',
    debug: false 
    });
    </script>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-122396021-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>


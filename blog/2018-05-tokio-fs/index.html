<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <link rel="apple-touch-icon" sizes="120x120" href="https://tokio-cn.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://tokio-cn.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://tokio-cn.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://tokio-cn.github.io/manifest.json">
    <link rel="mask-icon" href="https://tokio-cn.github.io/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#ffffff">

    
    <link rel="stylesheet" href="https://tokio-cn.github.io/css/bootstrap-reboot.css">
    <link rel="stylesheet" href="https://tokio-cn.github.io/css/bootstrap.css">
    <link rel="stylesheet" href="https://tokio-cn.github.io/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://tokio-cn.github.io/css/tokio.css">

    
    <link rel="alternate" type="application/rss+xml" href="https://tokio-cn.github.io/blog/index.xml" />

    <title>New Tokio release, now with filesystem support</title>
  </head>
  <body>
    <header class="navbar navbar-light navbar-toggleable-md bd-navbar">
      <nav class="tk-main-nav">
        <div class="d-flex justify-content-between hidden-lg-up">
            <a href="https://tokio-cn.github.io/" class="navbar-brand">
              <img src="https://tokio-cn.github.io/img/logo.png" class="align-middle" alt="">
            </a>
            <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#tk-main-nav" aria-label="Toggle navigation" aria-controls="tk-main-nav" aria-expanded="false">
              <span class="navbar-toggler-icon"></span>
            </button>
        </div>
        <div class="navbar-collapse collapse" id="tk-main-nav">
          <ul class="nav navbar-nav">
            <li class="nav-item hd-lg-down">
              <a class="navbar-brand" href="https://tokio-cn.github.io/"><img src="https://tokio-cn.github.io/img/logo.png" class="align-middle" alt=""></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://tokio-cn.github.io/">首页 <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://tokio-cn.github.io/docs/getting-started/hello-world/">文档</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://tokio-cn.github.io/community/">社区</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://tokio-cn.github.io/blog/2018-05-tokio-fs/">博客</a>
            </li>
          </ul>
        </div>
      </nav>
    </header>



<div class="tk-pageheader">
  <div class="container">
    <h1 class="display-4">New Tokio release, now with filesystem support</h1>
    <p class="lead">May 5, 2018</p>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col-md-3">

      <nav class="leftnav">
        <div class="" id="">
          <ul class="nav">
            
            <li class="active">
              <a href="https://tokio-cn.github.io/blog/2018-05-tokio-fs/" >New Tokio release, now with filesystem support</a>
            </li>
            
            <li class="active">
              <a href="https://tokio-cn.github.io/blog/2018-03-timers/" class="text-muted">New Timer implementation</a>
            </li>
            
            <li class="active">
              <a href="https://tokio-cn.github.io/blog/2018-03-tokio-runtime/" class="text-muted">Announcing the Tokio runtime</a>
            </li>
            
            <li class="active">
              <a href="https://tokio-cn.github.io/blog/2018-02-tokio-reform-shipped/" class="text-muted">Tokio Reform is Shipped and the Road to 0.2</a>
            </li>
            
            <li class="active">
              <a href="https://tokio-cn.github.io/blog/2017-09-tokio-reform/" class="text-muted">An RFC for a Tokio revamp</a>
            </li>
            
            <li class="active">
              <a href="https://tokio-cn.github.io/blog/2017-03-tokio-io/" class="text-muted">Announcing the tokio-io Crate</a>
            </li>
            
            <li class="active">
              <a href="https://tokio-cn.github.io/blog/2017-01-tokio-0-1/" class="text-muted">Announcing Tokio 0.1</a>
            </li>
            
          </ul>
        </div>
      </nav>

    </div>
    <div class="col-md-9">
      <div class="tk-content">
        

<p>It took a bit longer than I had initially hoped (as it always does), but a new
Tokio version has been released. This release includes, among other features, a
new <a href="https://docs.rs/tokio/0.1/tokio/fs/index.html">set of APIs</a> that allow performing filesystem operations from an
asynchronous context.</p>

<h2 id="filesystem-apis">Filesystem APIs</h2>

<p>Interacting with files (and other filesystem types) requires* blocking system
calls and we all know that blocking and asynchronous do not mix. So,
historically, when people ask &ldquo;how do I read from and write to files?&rdquo;, the
answer is to use a thread pool. The idea is that when a blocking read or
write must be performed, it is done on a thread pool so that it does not block
the asynchronous reactor.</p>

<p>Requiring a separate thread pool for performing file operations requires message
passing. The asynchronous task must send a message to the thread pool asking it
to do a read from the file, the thread pool does the read and fills a buffer
with the result. Then the thread pool sends the buffer back to the asynchronous
task. Not only does this add the overhead for dispatching messages, but it also
requires allocating buffers to send the data back and forth.</p>

<p>Now, with Tokio&rsquo;s new <a href="https://docs.rs/tokio/0.1/tokio/fs/index.html">filesystem APIs</a>, this message passing overhead is no
longer needed. A new <a href="https://docs.rs/tokio/0.1/tokio/fs/struct.File.html"><code>File</code></a> type is added. This type looks very similar to the
type provided by <code>std</code>, but it implements <code>AsyncRead</code> and <code>AsyncWrite</code>, making
it safe to use <em>directly</em> from an asynchronous task running on the Tokio
runtime.</p>

<p>Because the <a href="https://docs.rs/tokio/0.1/tokio/fs/struct.File.html"><code>File</code></a> type implements <code>AsyncRead</code> and <code>AsyncWrite</code>, it can be
used in much the same way that a TCP socket would be used from Tokio.</p>

<p>As of today, the filesystem APIs are pretty minimal. There are many other APIs
that need to be implemented to bring the Tokio filesystem APIs in line with
<code>std</code>, but those are left as an exercise to the reader to submit as PRs!</p>

<p>* Yes, there are some operating systems that provide fully asynchronous
filesystem APIs, but these are either incomplete or not portable.</p>

<h2 id="standard-in-and-out">Standard in and out</h2>

<p>This release of Tokio also includes asynchronous <a href="https://docs.rs/tokio/0.1/tokio/io/fn.stdin.html">standard input</a> and
<a href="https://docs.rs/tokio/0.1/tokio/io/fn.stdout.html">standard output</a> APIs. Because it is difficult to provide true
asynchronous standard input and output in a portable way, the Tokio versions use
a similar strategy as the blocking file operation APIs.</p>

<h2 id="blocking"><code>blocking</code></h2>

<p>These new APIs are made possible thanks to a new <a href="https://docs.rs/tokio-threadpool/0.1/tokio_threadpool/fn.blocking.html"><code>blocking</code></a> API that allows
annotating sections of code that will block the current thread. These blocking
sections can include blocking system calls, waiting on mutexes, or CPU heavy
computations.</p>

<p>By informing the Tokio runtime that the current thread will block, the runtime
is able to move the event loop from the current thread to another thread,
freeing the current thread up to permit blocking.</p>

<p>This is the opposite of using message passing to run blocking operations on a
threadpool. Instead of moving the blocking operation to another thread, the
entire event loop is moved.</p>

<p>In practice, moving the event loop to another thread is much cheaper than moving
the blocking operation. Doing so only requires a few atomic operations. The
Tokio runtime also keeps a pool of standby threads ready to allow moving the
event loop as fast as possible.</p>

<p>This also means that using the <code>blocking</code> annotation and <code>tokio-fs</code> must be done
from the context of the Tokio runtime and not other futures aware executors.</p>

<h2 id="current-thread-runtime">Current thread runtime</h2>

<p>The release also includes a <a href="https://docs.rs/tokio/0.1/tokio/runtime/current_thread/index.html">&ldquo;current thread&rdquo;</a> version of the runtime
(thanks <a href="https://github.com/kpp">kpp</a>). This is similar to the existing runtime,
but runs all components on the current thread. This allows running futures that
do not implement <code>Send</code>.</p>

        
        <div class="tk-next"><b>下一篇</b>：<a href = /blog/2018-03-timers/>
         New Timer implementation</a></div>
      </div>
    </div>
  </div>
</div>

    <footer class="tk-footer">
      <div class="text-muted tk-footer-gray d-flex justify-content-between">
        <div class="tk-footer-info">
          版权所有 © 2018 <a href="https://tokio.rs">Tokio 项目（作）</a> & <a href="https://hltj.me">灰蓝天际（译）</a>
        </div>
        <div class="tk-footer-social">
          <a href="https://twitter.com/tokio_rs" class="text-muted"><i class="fa fa-twitter" aria-hidden="true"></i></a>
          <a href="https://github.com/tokio-rs/tokio" class="text-muted"><i class="fa fa-github" aria-hidden="true"></i></a>
        </div>
      </div>
    </footer>

    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js" integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8" crossorigin="anonymous"></script>
    <script src="https://tokio-cn.github.io/js/bootstrap.min.js"></script>
    <script src="https://tokio-cn.github.io/js/highlight.js"></script>
    <script>
      $(function () {
        $("pre code").each(function(i, block) {
          
          if (block.className.indexOf('language-rust') >= 0) {
            var new_content = '';
            var lines = block.textContent.split('\n');
            for (var i = 0; i < lines.length; i++) {
              if (lines[i].indexOf('# ') == 0 || lines[i] == '#') {
                continue
              }
              new_content += lines[i].trimRight() + '\n';
            }
            block.textContent = new_content.replace(/\n\n\n/g, "\n\n").trimRight();
          }
          hljs.highlightBlock(block);
        });
      });
    </script>
    
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-122396021-1', 'auto');
ga('send', 'pageview');
</script>

  </body>
</html>


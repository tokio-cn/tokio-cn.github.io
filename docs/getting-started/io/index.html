<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <link rel="apple-touch-icon" sizes="120x120" href="https://tokio-cn.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://tokio-cn.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://tokio-cn.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://tokio-cn.github.io/manifest.json">
    <link rel="mask-icon" href="https://tokio-cn.github.io/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#ffffff">

    
    <link rel="stylesheet" href="https://tokio-cn.github.io/css/bootstrap-reboot.css">
    <link rel="stylesheet" href="https://tokio-cn.github.io/css/bootstrap.css">
    <link rel="stylesheet" href="https://tokio-cn.github.io/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://tokio-cn.github.io/css/tokio.css">

    
    <link rel="alternate" type="application/rss+xml" href="https://tokio-cn.github.io/blog/index.xml" />

    <title>I/O with Tokio</title>
  </head>
  <body>
    <header class="navbar navbar-light navbar-toggleable-md bd-navbar">
      <nav class="tk-main-nav">
        <div class="d-flex justify-content-between hidden-lg-up">
            <a href="https://tokio-cn.github.io/" class="navbar-brand">
              <img src="https://tokio-cn.github.io/img/logo.png" class="align-middle" alt="">
            </a>
            <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#tk-main-nav" aria-label="Toggle navigation" aria-controls="tk-main-nav" aria-expanded="false">
              <span class="navbar-toggler-icon"></span>
            </button>
        </div>
        <div class="navbar-collapse collapse" id="tk-main-nav">
          <ul class="nav navbar-nav">
            <li class="nav-item hd-lg-down">
              <a class="navbar-brand" href="https://tokio-cn.github.io/"><img src="https://tokio-cn.github.io/img/logo.png" class="align-middle" alt=""></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://tokio-cn.github.io/">首页 <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://tokio-cn.github.io/docs/getting-started/hello-world/">文档</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://tokio-cn.github.io/community/">社区</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://tokio-cn.github.io/blog/2018-05-tokio-fs/">博客</a>
            </li>
          </ul>
        </div>
      </nav>
    </header>



<div class="tk-pageheader">
  <div class="container">
    <h1 class="display-4">I/O with Tokio</h1>
    <p class="lead"></p>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col-md-3">

      <nav class="leftnav">
        <div class="" id="">
          <h5>入门</h5>
          <hr/>

          <div class="" id="">
            <ul class="nav">
              
              <li class="active">
                <a href="https://tokio-cn.github.io/docs/getting-started/hello-world/" class="text-muted">Hello World!</a>
              </li>
              
              <li class="active">
                <a href="https://tokio-cn.github.io/docs/getting-started/runtime-model/" class="text-muted">Runtime Model</a>
              </li>
              
              <li class="active">
                <a href="https://tokio-cn.github.io/docs/getting-started/futures/" class="text-muted">Futures</a>
              </li>
              
              <li class="active">
                <a href="https://tokio-cn.github.io/docs/getting-started/tasks/" class="text-muted">Tasks</a>
              </li>
              
              <li class="active">
                <a href="https://tokio-cn.github.io/docs/getting-started/io/" >I/O with Tokio</a>
              </li>
              
              <li class="active">
                <a href="https://tokio-cn.github.io/docs/getting-started/chat/" class="text-muted">Example: A Chat Server</a>
              </li>
              
            </ul>
          </div>

          <h5>深入</h5>
          <hr/>

          <div class="" id="">
            <ul class="nav">
              
              <li class="active">
                <a href="https://tokio-cn.github.io/docs/going-deeper/timers/" class="text-muted">Timers</a>
              </li>
              
              <li class="active">
                <a href="https://tokio-cn.github.io/docs/going-deeper/futures-mechanics/" class="text-muted">Essential combinators</a>
              </li>
              
              <li class="active">
                <a href="https://tokio-cn.github.io/docs/going-deeper/returning/" class="text-muted">Returning futures</a>
              </li>
              
              <li class="active">
                <a href="https://tokio-cn.github.io/docs/going-deeper/frames/" class="text-muted">Working with framed streams</a>
              </li>
              
              <li class="active">
                <a href="https://tokio-cn.github.io/docs/going-deeper/building-runtime/" class="text-muted">Building a runtime</a>
              </li>
              
            </ul>
          </div>

          <br/>
          <h5>参考</h5>
          <hr/>

          <div class="" id="">
            <ul class="nav">
              <li class="active">
                <a href="https://docs.rs/tokio" class="text-muted"><code>tokio</code> API docs</a>
              </li>
              <li class="active">
                <a href="https://docs.rs/futures/0.1" class="text-muted"><code>futures</code> API docs</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>

    </div>
    <div class="col-md-9">
      <div class="tk-content">
        <div class="github-edit">
            <a class="fa fa-github" href="https://github.com/hltj/tokio-website-cn/tree/master/content/docs/getting-started/io.md"> 在 GitHub 上编辑</a>
        </div>
        

<p>The <a href="https://docs.rs/tokio/0.1/tokio"><code>tokio</code></a> crate comes with TCP and UDP networking types. Unlike the types in
<code>std</code>, Tokio&rsquo;s networking types are based on the poll model and will notify the
task executors when their readiness states change (data is received and write
buffers are flushed). In the <a href="https://docs.rs/tokio/0.1/tokio/net/index.html"><code>tokio::net</code></a> module you&rsquo;ll find types like
<a href="https://docs.rs/tokio/0.1/tokio/net/struct.TcpListener.html"><code>TcpListener</code></a>, <a href="https://docs.rs/tokio/0.1/tokio/net/struct.TcpStream.html"><code>TcpStream</code></a>, and <a href="https://docs.rs/tokio/0.1/tokio/net/struct.UdpSocket.html"><code>UdpSocket</code></a>.</p>

<p>All of these types provide both a future API as well as a poll
API.</p>

<p>The Tokio net types are powered by a <a href="https://docs.rs/mio/">Mio</a> based reactor that, by default, is
started up lazily on a background thread. See <a href="https://docs.rs/tokio/0.1/tokio/reactor/index.html">reactor</a> documentation for more
details.</p>

<h2 id="future-api"><a href="#future-api">Using the Future API</a></h2>

<p>We&rsquo;ve already seen some of this earlier in the guide with the <a href="https://docs.rs/tokio/0.1/tokio/net/struct.TcpListener.html#method.incoming"><code>incoming</code></a>
function as well as the helpers found in <a href="https://docs.rs/tokio/0.1/tokio/io/index.html"><code>tokio_io::io</code></a>.</p>

<p>These helpers include:</p>

<ul>
<li><a href="https://docs.rs/tokio/0.1/tokio/net/struct.TcpListener.html#method.incoming"><code>incoming</code></a>: A stream of inbound TCP connections.</li>
<li><a href="https://docs.rs/tokio/0.1/tokio/io/fn.read_exact.html"><code>read_exact</code></a>: Read exactly <code>n</code> bytes into a buffer.</li>
<li><a href="https://docs.rs/tokio/0.1/tokio/io/fn.read_to_end.html"><code>read_to_end</code></a>: Read all bytes into a buffer.</li>
<li><a href="https://docs.rs/tokio/0.1/tokio/io/fn.write_all.html"><code>write_all</code></a>: Write the entire contents of a buffer.</li>
<li><a href="https://docs.rs/tokio/0.1/tokio/io/fn.copy.html"><code>copy</code></a>: Copy bytes from one I/O handle to another.</li>
</ul>

<p>A lot of these functions / helpers are generic over the <a href="https://docs.rs/tokio/0.1/tokio/io/trait.AsyncRead.html"><code>AsyncRead</code></a> and
<a href="https://docs.rs/tokio/0.1/tokio/io/trait.AsyncWrite.html"><code>AsyncWrite</code></a> traits. These traits are similar to <a href="https://doc.rust-lang.org/std/io/trait.Read.html"><code>Read</code></a> and <a href="https://doc.rust-lang.org/std/io/trait.Write.html"><code>Write</code></a> from
<code>std</code>, but are only for types that are &ldquo;future aware&rdquo;, i.e. follow the
mandated properties:</p>

<ul>
<li>Calls to <code>read</code> or <code>write</code> are <strong>nonblocking</strong>, they never block the calling
thread.</li>
<li>If a call would otherwise block then an error is returned with the kind of
<code>WouldBlock</code>. If this happens then the current future&rsquo;s task is scheduled to
receive a notification (an unpark) when the I/O is ready again.</li>
</ul>

<p>Note that users of <a href="https://docs.rs/tokio/0.1/tokio/io/trait.AsyncRead.html"><code>AsyncRead</code></a> and <a href="https://docs.rs/tokio/0.1/tokio/io/trait.AsyncWrite.html"><code>AsyncWrite</code></a> types should use
<a href="https://docs.rs/tokio/0.1/tokio/io/trait.AsyncRead.html#method.poll_read"><code>poll_read</code></a> and <a href="https://docs.rs/tokio/0.1/tokio/io/trait.AsyncWrite.html#method.poll_write"><code>poll_write</code></a> instead of directly calling <a href="https://doc.rust-lang.org/std/io/trait.Read.html"><code>read</code></a> and <a href="https://doc.rust-lang.org/std/io/trait.Write.html"><code>write</code></a>.</p>

<p>For example, here is how to accept connections, read 5 bytes from them, then
write the 5 bytes back to the socket:</p>

<pre><code class="language-rust"># #![deny(deprecated)]
# extern crate tokio;
#
# use tokio::io;
# use tokio::net::TcpListener;
# use tokio::prelude::*;
# fn main() {
#     let addr = &quot;127.0.0.1:6142&quot;.parse().unwrap();
#     let listener = TcpListener::bind(&amp;addr).unwrap();
let server = listener.incoming().for_each(|socket| {
    println!(&quot;accepted socket; addr={:?}&quot;, socket.peer_addr().unwrap());

    let buf = vec![0; 5];

    let connection = io::read_exact(socket, buf)
        .and_then(|(socket, buf)| {
            io::write_all(socket, buf)
        })
        .then(|_| Ok(())); // Just discard the socket and buffer

    // Spawn a new task that processes the socket:
    tokio::spawn(connection);

    Ok(())
})
# ;
# }
</code></pre>

<h2 id="poll-based"><a href="#poll-based">Using the Poll API</a></h2>

<p>The Poll based API is to be used when implementing <code>Future</code> by hand and you need
to return <code>Async</code>. This is useful when you need to implement your own
combinators that handle custom logic.</p>

<p>For example, this is how the <code>read_exact</code> future could be implemented for a
<code>TcpStream</code>.</p>

<pre><code class="language-rust"># #![deny(deprecated)]
# extern crate tokio;
# #[macro_use]
# extern crate futures;
# use tokio::io;
# use tokio::prelude::*;
#
# use tokio::net::TcpStream;
# use std::mem;
pub struct ReadExact {
    state: State,
}

enum State {
    Reading {
        stream: TcpStream,
        buf: Vec&lt;u8&gt;,
        pos: usize,
    },
    Empty,
}

impl Future for ReadExact {
    type Item = (TcpStream, Vec&lt;u8&gt;);
    type Error = io::Error;

    fn poll(&amp;mut self) -&gt; Result&lt;Async&lt;Self::Item&gt;, io::Error&gt; {
        match self.state {
            State::Reading {
                ref mut stream,
                ref mut buf,
                ref mut pos
            } =&gt; {
                while *pos &lt; buf.len() {
                    let n = try_ready!({
                        stream.poll_read(&amp;mut buf[*pos..])
                    });
                    *pos += n;
                    if n == 0 {
                        let err = io::Error::new(
                            io::ErrorKind::UnexpectedEof,
                            &quot;early eof&quot;);

                        return Err(err)
                    }
                }
            }
            State::Empty =&gt; panic!(&quot;poll a ReadExact after it's done&quot;),
        }

        match mem::replace(&amp;mut self.state, State::Empty) {
            State::Reading { stream, buf, .. } =&gt; {
                Ok(Async::Ready((stream, buf)))
            }
            State::Empty =&gt; panic!(),
        }
    }
}
# pub fn main() {}
</code></pre>

<h2 id="datagrams"><a href="#datagrams">Datagrams</a></h2>

<p>Note that most of this discussion has been around I/O or byte <em>streams</em>, which
UDP importantly is not! To accommodate this, however, the <a href="https://docs.rs/tokio/0.1/tokio/net/struct.UdpSocket.html"><code>UdpSocket</code></a> type
also provides a number of methods for working with it conveniently:</p>

<ul>
<li><a href="https://docs.rs/tokio/0.1/tokio/net/struct.UdpSocket.html#method.send_dgram"><code>send_dgram</code></a> allows you to express sending a datagram as a future, returning
an error if the entire datagram couldn&rsquo;t be sent at once.</li>
<li><a href="https://docs.rs/tokio/0.1/tokio/net/struct.UdpSocket.html#method.recv_dgram"><code>recv_dgram</code></a> expresses reading a datagram into a buffer, yielding both the
buffer and the address it came from.</li>
</ul>

        
        <div class="tk-next"><b>Next up</b>: <a href = /docs/getting-started/chat/>
         Example: A Chat Server</a></div>
      </div>
    </div>
  </div>
</div>

    <footer class="tk-footer">
      <div class="text-muted tk-footer-gray d-flex justify-content-between">
        <div class="tk-footer-info">
          版权所有 © 2018 <a href="https://tokio.rs">Tokio 项目</a> & <a href="https://hltj.me">灰蓝天际</a> 
        </div>
        <div class="tk-footer-social">
          <a href="https://twitter.com/tokio_rs" class="text-muted"><i class="fa fa-twitter" aria-hidden="true"></i></a>
          <a href="https://github.com/tokio-rs/tokio" class="text-muted"><i class="fa fa-github" aria-hidden="true"></i></a>
        </div>
      </div>
    </footer>

    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js" integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8" crossorigin="anonymous"></script>
    <script src="https://tokio-cn.github.io/js/bootstrap.min.js"></script>
    <script src="https://tokio-cn.github.io/js/highlight.js"></script>
    <script>
      $(function () {
        $("pre code").each(function(i, block) {
          
          if (block.className.indexOf('language-rust') >= 0) {
            var new_content = '';
            var lines = block.textContent.split('\n');
            for (var i = 0; i < lines.length; i++) {
              if (lines[i].indexOf('# ') == 0 || lines[i] == '#') {
                continue
              }
              new_content += lines[i].trimRight() + '\n';
            }
            block.textContent = new_content.replace(/\n\n\n/g, "\n\n").trimRight();
          }
          hljs.highlightBlock(block);
        });
      });
    </script>
    
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-122396021-1', 'auto');
ga('send', 'pageview');
</script>

  </body>
</html>

